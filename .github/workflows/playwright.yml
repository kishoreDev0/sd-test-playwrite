# name: Playwright Tests
# on:
#   push:
#     branches: [ main, master ]
#   pull_request:
#     branches: [ main, master ]
# jobs:
#   test:
#     timeout-minutes: 60
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v4
#     - uses: actions/setup-node@v4
#       with:
#         node-version: lts/*
#     - name: Install dependencies
#       run: npm ci
#     - name: Install Playwright Browsers
#       run: npx playwright install --with-deps
#     - name: Run Playwright tests
#       run: npx playwright test
#     - uses: actions/upload-artifact@v4
#       if: ${{ !cancelled() }}
#       with:
#         name: playwright-report
#         path: playwright-report/
#         retention-days: 30

name: Playwright CI (Docker)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      CI: true
      ALLURE_RESULTS_DIR: results/allure-results
      PW_OUTPUT_DIR: results/test-output
      BASE_URL: ${{ secrets.BASE_URL }}
      API_BASE_URL: ${{ secrets.API_BASE_URL }}
      TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
      TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker image
      run: |
        docker build -f docker/Dockerfile -t playwright-ci:latest .

    - name: Run tests in Docker container
      run: |
        # ensure results dir on host to gather artifacts
        mkdir -p results
        docker run --rm \
          -e CI=true \
          -e ALLURE_RESULTS_DIR=/usr/src/app/results/allure-results \
          -e PW_OUTPUT_DIR=/usr/src/app/results/test-output \
          -e BASE_URL=${{ secrets.BASE_URL }} \
          -e API_BASE_URL=${{ secrets.API_BASE_URL }} \
          -e TEST_USER_EMAIL=${{ secrets.TEST_USER_EMAIL }} \
          -e TEST_USER_PASSWORD=${{ secrets.TEST_USER_PASSWORD }} \
          -v $PWD/results:/usr/src/app/results \
          playwright-ci:latest

    - name: Generate Allure report
      run: |
        # Try to generate an HTML report; failure should not fail the job
        docker run --rm -v $PWD/results:/usr/src/app/results playwright-ci:latest bash -lc "allure generate /usr/src/app/results/allure-results -o /usr/src/app/results/allure-report || true"

    - name: Upload Allure results (raw)
      uses: actions/upload-artifact@v4
      with:
        name: allure-results
        path: results/allure-results

    - name: Upload Allure HTML report
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: results/allure-report

    - name: Upload Playwright artifacts (screenshots/videos/traces)
      uses: actions/upload-artifact@v4
      with:
        name: playwright-artifacts
        path: results/test-output
